# Node.js with Angular
# Build a Node.js project that uses Angular.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

name: 0.1.$(Rev:r)

trigger:
- master
- release

stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
      submodules: recursive

    - task: NodeTool@0
      inputs:
        versionSpec: '10.x'
      displayName: 'Install Node.js'

    - script: |
        npm install -g @angular/cli
        npm install
      displayName: 'Install Angular CLI and npm Packages'

    - script: |
        ng build -c staging
      displayName: 'Ng Build'

    - publish: 'dist/web-portal'
      artifact: WebPortal
      displayName: 'Publish Build Result to Artifacts'

    - task: NuGetCommand@2
      inputs:
        command: 'pack'
        packagesToPack: 'Microsoft.HPC.WebPortal.nuspec'
        versioningScheme: 'byBuildNumber'
        packDestination: '$(Build.ArtifactStagingDirectory)'
      displayName: 'Make NuGet Package'

    - task: NuGetCommand@2
      inputs:
        command: 'push'
        packagesToPush: $(Build.ArtifactStagingDirectory)/**/Microsoft.HPC.WebPortal.*.nupkg
        nuGetFeedType: 'internal'
        publishVstsFeed: '5e2011c9-a9d1-448b-9be7-9e9c97526134'
      displayName: 'Publish NuGet Package to Internal Feed'

- stage: Deploy
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/release'))
  jobs:
  - job: Deploy
    pool: 
      vmImage: win1803
    steps:
    - checkout: none

    - download: current
      artifact: WebPortal

    - task: WindowsMachineFileCopy@2
      inputs:
        SourcePath: '$(Pipeline.Workspace)/WebPortal'
        MachineNames: '$(StagingHost)'
        AdminUserName: '$(StagingHost.Username)'
        AdminPassword: '$(StagingHost.AdminPassword)'
        TargetPath: '\\WIN2016\WebPortal'
        CleanTargetBeforeCopy: true
      displayName: 'Deploy to $(StagingHost)'