# Node.js with Angular
# Build a Node.js project that uses Angular.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

name: 0.1.$(Rev:r)

trigger:
  batch: true
  branches:
    include:
    - master
    - release
  paths:
    exclude:
    - README.md
    - CONTRIBUTING.md
    - LICENSE

pr:
  branches:
    include:
    - master
  paths:
    exclude:
    - README.md
    - CONTRIBUTING.md
    - LICENSE

stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
      submodules: recursive

    - task: NodeTool@0
      inputs:
        versionSpec: '10.x'
      displayName: 'Install Node.js'

    - script: |
        npm install -g @angular/cli
        npm install
      displayName: 'Install Angular CLI and npm Packages'

    - script: |
        ng test --no-watch --no-progress --browsers=ChromeHeadlessCI --reporters=junit
      displayName: 'Ng Unit Test'

    - task: PublishTestResults@2
      inputs:
        testResultsFiles: 'unit-test-result.xml'
        failTaskOnFailedTests: true
      displayName: 'Publish Unit Test Results'

    - script: |
        ng e2e --protractor-config=e2e/protractor-ci.conf.js
      displayName: 'Ng E2E Test'

    - script: |
        ng build -c staging
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/release'))
      displayName: 'Ng Build'

    - publish: 'dist/web-portal'
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/release'))
      artifact: WebPortal
      displayName: 'Publish Build Result to Artifacts'

    - task: NuGetCommand@2
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/release'))
      inputs:
        command: 'pack'
        packagesToPack: 'Microsoft.HPC.WebPortal.nuspec'
        versioningScheme: 'byBuildNumber'
        packDestination: '$(Build.ArtifactStagingDirectory)'
      displayName: 'Make NuGet Package'

    - task: NuGetCommand@2
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/release'))
      inputs:
        command: 'push'
        packagesToPush: $(Build.ArtifactStagingDirectory)/**/Microsoft.HPC.WebPortal.*.nupkg
        nuGetFeedType: 'internal'
        publishVstsFeed: '5e2011c9-a9d1-448b-9be7-9e9c97526134'
      displayName: 'Publish NuGet Package to Internal Feed'

- stage: Deploy
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/release'))
  jobs:
  - job: Deploy
    pool:
      vmImage: windows-latest
    steps:
    - checkout: none

    - download: current
      artifact: WebPortal

    - task: AzureFileCopy@3
      inputs:
        SourcePath: '$(Pipeline.Workspace)/WebPortal'
        azureSubscription: $(Subscription)
        resourceGroup: $(ResourceGroup)
        storage: $(StorageAccount)
        Destination: 'AzureVMs'
        ResourceFilteringMethod: machineNames
        MachineNames: $(TargetHosts)
        vmsAdminUserName: $(TargetHosts.AdminUserName)
        vmsAdminPassword: $(TargetHosts.AdminPassword)
        TargetPath: $(TargetHosts.Path)
        CleanTargetBeforeCopy: true
        enableCopyPrerequisites: true
      displayName: 'Deploy to $(TargetHosts)'
